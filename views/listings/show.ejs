<% layout("/layouts/boilerplate") %>

<div class="row mt-4">
  <div class="col-8 offset-2">

    <!-- Listing Title & Owner -->
    <h3><%= listing.title || 'No Title' %></h3>
    <p class="text-muted mb-2">
      @ <%= listing.owner ? listing.owner.username : 'Unknown' %> | <%= listing.category || 'None' %>
    </p>

    <!-- Listing Image & Details -->
    <div class="card mb-3 listing-card">
      <img src="<%= listing.image ? listing.image.url : '/images/placeholder.png' %>" class="card-img-top" alt="listing_image">
      <div class="card-body">
        <p><%= listing.description || '' %></p>
        <p>â‚¹ <%= listing.price ? listing.price.toLocaleString("en-IN") : '0' %></p>
        <p><%= listing.location || 'Unknown' %>, <%= listing.country || 'Unknown' %></p>
      </div>
    </div>

    <!-- Edit/Delete Buttons for Owner -->
    <% if(currUser && listing.owner && listing.owner._id.equals(currUser._id)) { %>
      <div class="d-flex gap-2 mb-3">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>
        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
          <button class="btn btn-danger">Delete</button>
        </form>
      </div>
    <% } %>

    <!-- Flash Messages -->
    <%- include("../includes/flash.ejs") %>

    <!-- Reviews Section -->
    <div class="mb-4">
      <% if(currUser) { %>
        <h5>Leave a Review</h5>
        <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <div class="mb-2">
            <label>Rating</label>
            <input type="number" name="review[rating]" min="1" max="5" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Comment</label>
            <textarea name="review[comment]" class="form-control" rows="3" required></textarea>
          </div>
          <button class="btn btn-outline-dark">Submit</button>
        </form>
      <% } %>

      <% if(listing.reviews && listing.reviews.length > 0) { %>
        <h5 class="mt-4">All Reviews</h5>
        <% listing.reviews.forEach(review => { %>
          <div class="card mb-2 p-2">
            <strong>@<%= review.author ? review.author.username : 'Anonymous' %></strong>
            <p>Rating: <%= review.rating || '0' %> / 5</p>
            <p><%= review.comment %></p>

            <% if(currUser && review.author && review.author._id.equals(currUser._id)) { %>
              <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                <button class="btn btn-sm btn-dark">Delete</button>
              </form>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>

    <!-- Map -->
    <div class="mb-3">
      <h5>Location</h5>
      <div id="map" style="width: 100%; height: 350px; border-radius: 10px;"></div>
    </div>

  </div>
</div>

<!-- Pass coordinates to JS -->
<script>
  window.coordinates = <%- JSON.stringify(listing.geometry ? listing.geometry.coordinates : [0,0]) %>;
</script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= mapApiKey %>&callback=initMap"></script>
